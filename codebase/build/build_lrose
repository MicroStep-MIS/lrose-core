#! /bin/bash
#
# Building LROSE and required libraries
# =====================================
#
# Downloading:
# ------------
#
# Download the source tar file from:
#
#    ftp.rap.ucar.edu/pub/titan/lrose
#
# untar, and cd into the resulting directory.
#
# By default the libraries and applications will be installed in:
#
#   /usr/local/include
#   /usr/local/lib
#   /usr/local/bin
#
# You can change the install location by specifying it as
# a single argument to this script.
#
# For example:
#
#   build_lrose /tmp/lrose
#
# will install in:
#
#   /tmp/lrose/include
#   /tmp/lrose/lib
#   /tmp/lrose/bin

#--------------------------------------------------------------------
# usage function
#

function usage() {
    echo
    echo "Usage: build_lrose [ -h ] [ prefix ]"
    echo
    echo "  -h: produce this usage list"
    echo "  optionally set the prefix"
    echo
}

# set the path

export PATH=${PATH}:.:/bin:./make_bin:/usr/bin:/sbin:/usr/sbin:/usr/bin/X11:/usr/local/bin:/usr/local/sbin:$HOME/bin:/usr/lib64/qt4/bin:/usr/lib/qt4/bin
startingDir=`pwd`

# set the install prefix

prefix=/usr/local/lrose

if [ $# -gt 0 ]
then
  if [ "$1" == -h -o "$2" == -h ] 
  then
    usage
    exit 0
  fi
  prefix=$1
fi

echo "Using prefix: $prefix"

# set RPATH to be locatable relative to $ORIGIN, via LDFLAGS

export "LDFLAGS=-L${prefix}/lib -Wl,-rpath,'\$\$ORIGIN'/lrose_runtime_libs:${prefix}/lib"

# first create the 'moc'-able files for Qt apps

cd apps/radar/src/HawkEye
rm -f moc_*   # remove any old moc_* files before we (re)generate them
qmake-qt4 -o Makefile.qmake
make -f Makefile.qmake mocables

# Build HDF5, NETCDF and UDUNITS
# ------------------------------

# Checkout https://github.com/NCAR/lrose-netcdf
# build from there

# Build lrose - libraries and binaries
# ------------------------------------

export CPPFLAGS=" -std=c++11 "

export FC gfortran
export F77 gfortran
export F90 gfortran

cd $startingDir
./configure --with-hdf5=${prefix} --with-netcdf=${prefix} --prefix=${prefix} || exit 1

cd $startingDir
cd libs
make -k -j 8
make -k install-strip

cd $startingDir
cd apps
make -k -j 8
make -k install-strip

# Install perl lib modules
#-------------------------

cd $startingDir
cd libs/perl5/src
mkdir -p ${prefix}/lib/perl5
/bin/cp *pm ${prefix}/lib/perl5

# Install scripts
#----------------

cd $startingDir
cd apps/procmap/src/scripts
./install_scripts.lrose ${prefix}/bin

cd $startingDir
cd apps/scripts/src
./install_scripts.lrose ${prefix}/bin

# Checking the build
# ------------------

cd $startingDir
./build/check_build $prefix
