/* *=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=* */
/* ** Copyright UCAR (c) 1990 - 2016                                         */
/* ** University Corporation for Atmospheric Research (UCAR)                 */
/* ** National Center for Atmospheric Research (NCAR)                        */
/* ** Boulder, Colorado, USA                                                 */
/* ** BSD licence applies - redistribution and use in source and binary      */
/* ** forms, with or without modification, are permitted provided that       */
/* ** the following conditions are met:                                      */
/* ** 1) If the software is modified to produce derivative works,            */
/* ** such modified software should be clearly marked, so as not             */
/* ** to confuse it with the version available from UCAR.                    */
/* ** 2) Redistributions of source code must retain the above copyright      */
/* ** notice, this list of conditions and the following disclaimer.          */
/* ** 3) Redistributions in binary form must reproduce the above copyright   */
/* ** notice, this list of conditions and the following disclaimer in the    */
/* ** documentation and/or other materials provided with the distribution.   */
/* ** 4) Neither the name of UCAR nor the names of its contributors,         */
/* ** if any, may be used to endorse or promote products derived from        */
/* ** this software without specific prior written permission.               */
/* ** DISCLAIMER: THIS SOFTWARE IS PROVIDED "AS IS" AND WITHOUT ANY EXPRESS  */
/* ** OR IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED      */
/* ** WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.    */
/* *=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=* */
/*********************************************************************
 * XVIEW_JIFFY.C  A Simple template for an application using XVIEW
 * Frank Hage	July 1993 NCAR, Research Applications Program
 */

#define MAIN

#include "pos_report.h"
 
void process_args( int argc, char *argv[]);
void init_xview( int *argc_ptr, char    *argv[]);
int   x_error_proc( Display *disp, XErrorEvent *event);
Notify_value base_win_destroy( Notify_client   client, Destroy_status  status);
void timer_func( Notify_client   client, int which);
void start_timer(void);
void get_parameter_database( char    *fname);
void init_data_space(void);
void modify_xview_objects(void);


/********************************************************************
 * MAIN: Process arguments, initialize and begin application
 */
 
void
main(int argc, char **argv)
{

	xv_init(XV_INIT_ARGC_PTR_ARGV,&argc,argv,XV_X_ERROR_PROC,x_error_proc,NULL);
	 
	process_args(argc,argv);	/* process command line arguments */

	/* initialize globals, get/set defaults, establish data sources etc. */
	init_data_space();
 
	init_xview(&argc,argv); /* create all Xview objects */	

	/* make changes to xview objects not available from DevGuide */
	modify_xview_objects();

	start_timer();			/* start up the timer */

	xv_main_loop(gd.gui_objects->main_bw);
	exit(0);
}

#define ARG_OPTION_STRING   "d:"
/*****************************************************************
 * PROCESS_ARGS: Progess command line arguments. Set option flags
 *	   And print usage info if necessary
 */

void process_args( int argc, char *argv[])
{
	int err_flag =0;
	int	 c;
	extern  int optind; /* index to remaining arguments */
	extern  char *optarg;   /* option argument string */

	gd.db_name = "pos_report.defaults";	/* Set the default data base name */
	 
	while ((c = getopt(argc, argv,ARG_OPTION_STRING)) != EOF) {
		switch(c) {
			case 'd' :	/* alternate parameter database file */
				gd.db_name = optarg;
			break;
 
			case '?':   /* error in options */
			default:
				err_flag++;
			break;
		}
 
	};
 
	if(err_flag) {
		fprintf(stderr,"Usage:Jiffy [-d alternate_parameter_file] \n");
		exit(-1);
	}
}  
 
/***************************************************************************
 * INIT_XVIEW : Initialize the base frame and other global objects
 */ 
 
void init_xview( int *argc_ptr, char	*argv[])
{
	Notify_value	base_win_destroy(); /* destroy interposer */
	int	x_error_proc();
 

	gd.gui_objects = pos_gui_main_bw_objects_initialize(NULL, NULL);	
	notify_interpose_destroy_func(gd.gui_objects->main_bw,base_win_destroy);

	gd.dpy = (Display *) xv_get(gd.gui_objects->main_bw,XV_DISPLAY);
 
	gcc_initialize(gd.gui_objects->main_bw,"Overlay Color Chooser"); 

	/* get a default global GC */
	gd.def_gc = DefaultGC(gd.dpy,DefaultScreen(gd.dpy));

}

/*****************************************************************
 * X_ERROR_PROC: Handle errors generated by the X server
 */
 
int x_error_proc( Display *disp, XErrorEvent *event)
{
	char	text[256];
 
	XGetErrorText(disp,event->error_code,text,256);
	fprintf(stderr,"Generated X error : %s, ID:%u\n",text,event->resourceid);
 
	switch(event->error_code) {
		default :
			return   XV_OK;
		break;
 
		case BadAlloc :
			return   XV_OK;
		break;
	}
}
 
/*****************************************************************
 * BASE_WIN_DESTROY: Interposition for base frame destroys
 */

Notify_value
base_win_destroy( Notify_client   client, Destroy_status  status)
{
	int i;
	char	fname[1024];

	switch(status) {
		case DESTROY_CLEANUP:
 
		case DESTROY_PROCESS_DEATH:
			return notify_next_destroy_func(client,status);
		break;
 
		case DESTROY_CHECKING:
			return NOTIFY_DONE;
		break;
 
		case DESTROY_SAVE_YOURSELF:
			return NOTIFY_DONE;
		break;
	}
}

/************************************************************************
 * TIMER_FUNC: This routine supervises timed operations 
 *
 */

void timer_func( Notify_client   client, int which)
{
    static int last_no = 0;

    if(gd.coord_expt->pointer_seq_num != last_no) {
	report_relative_position();
	last_no = gd.coord_expt->pointer_seq_num;
    }
}
 
/**********************************************************************
 * START_TIMER:  Start up the interval timer
 */

void start_timer(void)
{
    struct  itimerval   timer;
    long ntimes,up_interv;

    ntimes = XRSgetLong(gd.db, "pos_report.timer_polling", 10);

    /* set up interval timer interval */
    timer.it_value.tv_sec = 0;
    timer.it_value.tv_usec = 1000000 / ntimes;
    timer.it_interval.tv_sec = 0;
    timer.it_interval.tv_usec = 1000000 / ntimes;

    /* Set the interval timer function and start timer */
    notify_set_itimer_func(gd.gui_objects->main_bw,
                           (Notify_func)timer_func,
                           ITIMER_REAL, &timer, NULL); /*  */

}

/************************************************************************
 * GET_PARAMETER_DATABASE: Load the parameter data base and set initial
 *     parameters
 *
 */

void    get_parameter_database( char    *fname)
{
    /* Retrieve the application's Default/Resource data base */
    gd.db = XrmGetFileDatabase(fname);
    if(gd.db == NULL) {
        fprintf(stderr,"Could'nt open or find %s\n",gd.db_name);
        exit(-1);
    }
}

/*****************************************************************
 * INIT_DATA_SPACE : Init all globals and set up defaults
 */

void init_data_space(void)
{
    int i;
    int coord_key;
    char    string[128];

    INSTANCE = xv_unique_key(); /* get keys for retrieving data */

    get_parameter_database(gd.db_name); /* load the program's parameter database*/

    gd.num_origins = XRSgetLong(gd.db, "pos_report.num_origins", 1);
    gd.selected_origin = 0;

    coord_key = XRSgetLong(gd.db, "cidd.coord_key", 63500);
    if((gd.coord_expt = (coord_export_t *) ushm_create(coord_key, sizeof(coord_export_t), 0666)) == NULL) {
        fprintf(stderr, "Couldn't create shared memory segment for Aux process communications\n");
        exit(-1);
    }
     
    if(gd.num_origins > MAX_ORIGINS) {
	fprintf(stderr,"pos_report: Too many origins. Only configured for %d\n",MAX_ORIGINS);
	fprintf(stderr,"pos_report: Truncating list\n");
	gd.num_origins = MAX_ORIGINS;
    }

    for(i=0; i < gd.num_origins; i++) {
	sprintf(string,"pos_report.origin%d_label",i);
	gd.origin[i].label = XRSgetString(gd.db,string, "DEN");

	sprintf(string,"pos_report.origin%d_lat",i);
	gd.origin[i].lat = XRSgetDouble(gd.db,string, 39.8000);

	sprintf(string,"pos_report.origin%d_lon",i);
	gd.origin[i].lon = XRSgetDouble(gd.db,string,-104.8839);

	sprintf(string,"pos_report.origin%d_angle",i);
	gd.origin[i].angle = XRSgetDouble(gd.db,string,0.0);
    }
}

/*****************************************************************
 * MODIFY_XVIEW_OBJECTS : Modify any Xview objects that couldn't
 *    be set up in Devguide. This is primarily to avoid manually
 *    changing any *ui.c file
 */

void modify_xview_objects(void)
{
    int i;
    char string[128];

    for(i=0; i < gd.num_origins; i++) {
	xv_set(gd.gui_objects->origin_lst,
	    PANEL_LIST_STRING, i, gd.origin[i].label,
	    NULL);
    }

     /* Select the first row */
     xv_set(gd.gui_objects->origin_lst,PANEL_LIST_SELECT,gd.selected_origin,TRUE,NULL);

     sprintf(string,"From %s:",gd.origin[gd.selected_origin].label);
     xv_set(gd.gui_objects->label_msg,PANEL_LABEL_STRING,string,NULL);
}


/* SCCS info
 *   %W% %D% %T%
 *   %F% %E% %U%
 *
 * RCS info
 *   $Author: dixon $
 *   $Locker:  $
 *   $Date: 2016/03/07 18:28:26 $
 *   $Id: pos_report.c,v 1.2 2016/03/07 18:28:26 dixon Exp $
 *   $Revision: 1.2 $
 *   $State: Exp $
 *
 *   $Log: pos_report.c,v $
 *   Revision 1.2  2016/03/07 18:28:26  dixon
 *   Changing copyright/license to BSD
 *
 *   Revision 1.1  1995/07/11 20:05:55  fhage
 *   New placement in RPA's CVS Tree
 *
 * Revision 1.1.1.1  1994/01/27  16:39:19  fhage
 * INitial Checkin
 *
 */

#ifndef LINT
static char RCS_id[] = "$Id: pos_report.c,v 1.2 2016/03/07 18:28:26 dixon Exp $";
static char SCCS_id[] = "%W% %D% %T%";
#endif /* not LINT */
