#! /bin/bash

#--------------------------------------------------------------------
#
# Build from src release using configure
#
# Mike Dixon, EOL, NCAR, Boulder, CO, USA
# March 2018
#
#--------------------------------------------------------------------

#--------------------------------------------------------------------
# usage function
#

function usage() {
    echo
    echo "Usage: build_from_src_release [ -h ] [ prefix ]"
    echo
    echo "  -h: produce this usage list"
    echo "  optionally set the prefix"
    echo
}

# set the path

export PATH=.:/bin:./make_bin:/usr/bin:/sbin:/usr/sbin:/usr/bin/X11:/usr/local/bin:/usr/local/sbin:$HOME/bin

# set package name

package=lrose

#######################################################
# get run time

year=`date +'%Y'`
month=`date +'%m'`
day=`date +'%d'`
hour=`date +'%H'`
min=`date +'%M'`
sec=`date +'%S'`

#--------------------------------------------------------------------

echo
echo "*********************************************************************"
echo
echo "  Building ${package} package from src release"
echo
echo "  NCAR, Boulder, CO, USA"
echo
echo "  $year/$month/$day $hour:$min:$sec"
echo
echo "*********************************************************************"
echo

# set the install prefix

prefix=${HOME}

if [ $# -gt 0 ]
then
  if [ "$1" == -h -o "$2" == -h ] 
  then
    usage
    exit 0
  fi
  prefix=$1
fi

echo
echo "*********************************************************************"
echo
echo "  Building ${package} package from src release"
echo
echo "  NCAR, Boulder, CO, USA"
echo
echo "  $year/$month/$day $hour:$min:$sec"
echo
echo "*********************************************************************"
echo

echo "Installing in prefix: $prefix"

mkdir -p $prefix

cd /tmp
tar xvfz ~/releases/lrose-blaze/lrose-blaze-20180322.src.tgz
cd lrose-blaze-20180322.src/lrose-netcdf
./build_and_install_netcdf -x $prefix
cd ../codebase
./configure --prefix=${prefix} --with-hdf5=${prefix} --with-netcdf=${prefix}
make -j 4
make install

#--------------------------------------------------------------------
# done

echo
echo "  **************************************************"
echo "  *** Done building from src release ***"
echo "  *** bin dir is ${prefix}/bin"
echo "  **************************************************"
echo

exit 0
